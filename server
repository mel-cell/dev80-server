#!/bin/bash

# Color definitions
GRAY='\033[0;37m'
NC='\033[0m'  # No Color

# Path ke folder project kamu
PROJECT_DIR="$HOME/monorepo-devenv"

# Fungsi garis pembatas
horizontal_line() {
  printf '%0.s-' {1..60}
  echo ""
}

# Fungsi kotak untuk judul
draw_box() {
  local text="$1"
  local len=${#text}
  local width=$((len + 4))
  local line="+"
  for ((i=0; i<width; i++)); do line="${line}-"; done
  line="${line}+"
  echo "$line"
  printf "| %-${len}s |\n" "$text"
  echo "$line"
}

# Interactive menu
show_menu() {
  local options=("Start Services" "Stop Services" "Restart Services" "View Logs" "Enter Container" "Check Status" "MySQL Shell" "Clean Up" "Help" "Exit")
  local selected=0

  while true; do
    clear
    echo "Server - Docker Development Environment"
    echo "======================================="
    for i in "${!options[@]}"; do
      if [ $i -eq $selected ]; then
        echo "> ${options[$i]}"
      else
        echo "  ${options[$i]}"
      fi
    done

    read -s -n3 key
    case $key in
      $'\e[A') ((selected--)); if [ $selected -lt 0 ]; then selected=$((${#options[@]}-1)); fi ;; # up
      $'\e[B') ((selected++)); if [ $selected -ge ${#options[@]} ]; then selected=0; fi ;; # down
      "") break ;; # enter
    esac
  done

  case $selected in
    0) draw_box "Starting services..."; run_cmd up -d; draw_box "Services started." ;;
    1) draw_box "Stopping services..."; run_cmd down; draw_box "Services stopped." ;;
    2) draw_box "Restarting services..."; run_cmd down; run_cmd up -d; draw_box "Services restarted." ;;
    3) draw_box "Viewing logs..."; run_cmd logs -f ;;
    4) echo "Enter container name:"; read container; run_cmd exec -it "$container" bash ;;
    5) check_status ;;
    6) draw_box "Entering MySQL shell"; docker compose exec -it mysql mysql -u root -p ;;
    7) draw_box "Cleaning up..."; run_cmd down -v --remove-orphans; docker system prune -f; draw_box "Cleaned up." ;;
    8) show_help ;;
    9) exit 0 ;;
  esac
}

# Progress bar
progress_bar() {
  local duration=$1
  local msg="$2"
  local width=20
  local fill="#"
  local empty="-"
  for ((i=0; i<=width; i++)); do
    local bar=""
    for ((j=0; j<i; j++)); do bar+="${fill}"; done
    for ((j=i; j<width; j++)); do bar+="${empty}"; done
    printf "\r%s [%s]" "$msg" "$bar"
    sleep $(awk "BEGIN {print $duration/$width}")
  done
  echo ""
}

# Cek apakah folder ada
if [ ! -d "$PROJECT_DIR" ]; then
  draw_box "Folder tidak ditemukan"
  echo -e "${GRAY}$PROJECT_DIR${NC}"
  horizontal_line
  exit 1
fi

# Pindah ke folder project
cd "$PROJECT_DIR" || exit 1

# Fungsi bantu
run_cmd() {
  docker compose "$@"
}

# Fungsi status dengan tabel rapi
check_status() {
  horizontal_line
  echo -e "${GRAY}Status saat ini:${NC}"
  horizontal_line
  if [ "$(docker compose ps -q)" ]; then
    docker compose ps --format "table {{.Name}}\t{{.State}}\t{{.Status}}\t{{.Ports}}" | column -t -s $'\t'
    horizontal_line
  else
    echo -e "${GRAY}Tidak ada service yang jalan.${NC}"
    horizontal_line
  fi
}

# Tampilkan menu interaktif jika tidak ada argumen
if [ $# -eq 0 ]; then
  show_menu
fi

# Jalankan command
case "$1" in
  start)
    draw_box "Memulai service..."
    progress_bar 2 "Memulai"
    run_cmd up -d
    draw_box "Semua service telah dijalankan!"
    ;;
  stop)
    draw_box "Menghentikan service..."
    progress_bar 2 "Menghentikan"
    run_cmd down
    draw_box "Semua service telah dihentikan."
    ;;
  restart)
    draw_box "Merestart service..."
    progress_bar 1 "Menghentikan"
    run_cmd down
    progress_bar 1 "Memulai"
    run_cmd up -d
    draw_box "Service berhasil direstart!"
    ;;
  logs)
    draw_box "Menampilkan log..."
    run_cmd logs -f
    ;;
  enter)
    if [ -z "$2" ]; then
      draw_box "Usage: server enter [service-name]"
      exit 1
    fi
    draw_box "Masuk ke container: $2"
    run_cmd exec -it "$2" bash
    ;;
  status)
    check_status
    ;;
  mysql)
    draw_box "Masuk ke MySQL Shell"
    docker compose exec -it mysql mysql -u root -p
    ;;
  clean)
    draw_box "Membersihkan sisa container/image yang tidak dipakai"
    progress_bar 1 "Membersihkan"
    docker compose down -v --remove-orphans
    docker system prune -f
    draw_box "Sistem sudah dibersihkan!"
    ;;
  help)
    draw_box "Panduan Penggunaan"
    echo -e "${GRAY}"
    echo "server start         # Jalankan semua service"
    echo "server stop          # Hentikan semua service"
    echo "server restart       # Restart service"
    echo "server logs          # Lihat log secara real-time"
    echo "server enter [name]  # Masuk ke container tertentu"
    echo "server status        # Cek status container"
    echo "server mysql         # Masuk ke MySQL shell"
    echo "server clean         # Hapus container/image yang tidak terpakai"
    echo -e "${NC}"
    horizontal_line
    ;;
  *)
    draw_box "Penggunaan: server [start|stop|restart|logs|enter <container>|status|mysql|clean|help]"
    exit 1
    ;;
esac
